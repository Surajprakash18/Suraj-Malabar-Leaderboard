<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGD Hesaraghatta | Suraj Prakash v38.6</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050510">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --neon-gold: #ffd700;
            --neon-blue: #00f3ff;
            --neon-green: #39ff14;
            --neon-red: #ff073a;
            --bg-dark: #050510;
            --card-bg: rgba(20, 20, 30, 0.9);
        }

        @font-face {
            font-family: 'Cyber';
            src: url('https://fonts.cdnfonts.com/s/29364/Cyberpunk.woff') format('woff');
        }

        body {
            margin: 0; padding: 10px; background-color: var(--bg-dark);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 300" opacity="0.15"><path d="M100 250 L100 100 L150 50 L200 100 L200 250 Z M400 250 L400 150 L450 120 L500 150 L500 250" stroke="cyan" fill="none" stroke-width="2"/></svg>');
            background-size: cover; background-attachment: fixed; color: white;
            font-family: 'Cyber', 'Segoe UI', Roboto, sans-serif; overflow-x: hidden; padding-bottom: 100px;
        }

        @keyframes rotateCrown { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        .crown { display: inline-block; animation: rotateCrown 4s linear infinite; font-size: 1.2rem; filter: drop-shadow(0 0 5px var(--neon-gold)); vertical-align: middle; }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }
        .rank-tag { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 0.6rem; font-weight: bold; margin-left: 5px; animation: float 3s infinite ease-in-out; }

        h1, h2, h3 { text-transform: uppercase; letter-spacing: 1px; margin: 0; text-align: center; }
        .main-title { font-size: 1.6rem; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); margin-bottom: 3px; cursor: pointer; }
        .sub-title { font-size: 0.7rem; color: var(--neon-gold); text-shadow: 0 0 5px var(--neon-gold); margin-bottom: 10px; opacity: 0.8; }
        
        #daysPending { font-size: 0.9rem; color: var(--neon-red); font-weight: 900; text-shadow: 0 0 10px var(--neon-red); margin-bottom: 20px; text-align: center; display: block; letter-spacing: 2px; }
        .critical-flash { animation: alert-flash 1s infinite alternate; }
        @keyframes alert-flash { from { opacity: 1; text-shadow: 0 0 15px var(--neon-red); } to { opacity: 0.3; text-shadow: 0 0 2px var(--neon-red); } }

        /* Sync Indicator Styling */
        .sync-dot { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; display: inline-block; margin-right: 6px; box-shadow: 0 0 8px var(--neon-green); vertical-align: middle; }
        .pulse { animation: sync-pulse 2s infinite; }
        @keyframes sync-pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        .section-container { background: var(--card-bg); border: 1.2px solid var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); border-radius: 12px; padding: 15px; margin-bottom: 25px; backdrop-filter: blur(8px); }
        .section-header { font-size: 1.1rem; margin-bottom: 15px; text-shadow: 0 0 5px white; }
        .team-title-highlight { font-size: 0.95rem; font-weight: 900; letter-spacing: 1px; }
        .leader-name-bracket { font-size: 0.9rem; color: #ffffff !important; opacity: 1 !important; font-weight: bold; text-shadow: 0 0 5px rgba(255,255,255,0.8); }

        .team-growth-highlight { font-size: 0.85rem; font-weight: 900; margin-left: 12px; }
        .growth-pos { color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green); }
        .growth-neg { color: var(--neon-red); text-shadow: 0 0 8px var(--neon-red); }

        .team-badge-highlight { font-weight: 900; padding: 2px 8px; border-radius: 3px; font-size: 0.6rem; letter-spacing: 1px; margin-bottom: 6px; display: inline-block; }

        .team-race-row { display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; transition: 0.3s; }
        .race-track { height: 24px; background: rgba(0,0,0,0.5); border-radius: 12px; flex: 1; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .race-bar { height: 100%; border-radius: 12px; transition: width 1.5s ease; position: relative; display: flex; align-items: center; justify-content: flex-end; }
        .race-marker { font-size: 1.5rem; position: absolute; right: -8px; filter: drop-shadow(0 0 5px white); }

        .staff-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .staff-card { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.3s; }
        .staff-name-large { font-size: 0.9rem; font-weight: bold; margin-bottom: 3px; display: flex; align-items: center; justify-content: space-between; }
        .growth-box { font-size: 0.65rem; font-weight: bold; }
        .staff-details { font-size: 0.7rem; opacity: 0.8; display: flex; justify-content: space-between; }

        .ticker-wrap { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; border-top: 1.5px solid var(--neon-blue); color: var(--neon-blue); overflow: hidden; padding: 8px 0; z-index: 5000; }
        .ticker-move { display: inline-block; white-space: nowrap; padding-left: 100%; animation: ticker 25s linear infinite; font-size: 0.85rem; font-weight: bold; }
        @keyframes ticker { from { transform: translate(0, 0); } to { transform: translate(-100%, 0); } }

        .gear { position: fixed; bottom: 60px; right: 15px; font-size: 1.3rem; opacity: 0.15; cursor: pointer; z-index: 6000; }
        #adminModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 7000; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-dark); border: 2px solid var(--neon-gold); padding: 20px; border-radius: 12px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .input-box { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; font-size: 0.8rem; }
        input { background: #111; border: 1px solid var(--neon-blue); color: white; padding: 5px; width: 55px; text-align: center; }

        .c-gold { color: var(--neon-gold); } .c-blue { color: var(--neon-blue); } .c-green { color: var(--neon-green); } .c-red { color: var(--neon-red); }
        .bg-gold { background: var(--neon-gold); } .bg-blue { background: var(--neon-blue); } .bg-green { background: var(--neon-green); } .bg-red { background: var(--neon-red); }
    </style>
</head>
<body>

    <h1 class="main-title" onclick="checkVersion()">MGD HESARAGHATTA</h1>
    <h2 class="sub-title">Managed By Suraj Prakash</h2>
    <div id="daysPending">CALCULATING DEADLINE...</div>

    <div class="section-container">
        <h3 class="section-header">TEAM RACE STANDINGS</h3>
        <div id="teamRaceCont"></div>
    </div>

    <div class="section-container">
        <h3 class="section-header">STAFF LEADERBOARD</h3>
        <div id="staffGridCont" class="staff-grid"></div>
    </div>

    <div id="lastSyncStamp" style="text-align: center; color: var(--neon-blue); font-size: 0.55rem; margin-top: 15px; opacity: 0.6; letter-spacing: 1px; text-shadow: 0 0 5px var(--neon-blue);">
        <span id="syncDot" class="sync-dot pulse"></span>LAST REFRESH: WAITING FOR SYNC...
    </div>

    <div class="ticker-wrap">
        <div class="ticker-move" id="liveTicker">LOADING RECOGNITION BROADCAST...</div>
    </div>

    <div class="gear" onclick="openAdmin()">‚öôÔ∏è</div>
    <div id="adminModal">
        <div class="modal-content">
            <div style="font-size: 0.55rem; color: #555; margin-bottom: 10px; text-align: right;">
                System: PWA-CORE | Build: v38.6 | Status: <span class="c-green">ONLINE</span>
            </div>
            <h2 class="c-gold" style="font-size:1.1rem; margin-bottom:12px;">ADMIN CONSOLE v38.6</h2>
            <div id="adminFields"></div>
            <input type="text" id="in-ticker" placeholder="Update Broadcast" style="width:100%; margin:12px 0; padding:10px; font-size: 0.75rem;">
            <button onclick="saveData()" style="width:100%; padding:12px; background:var(--neon-green); border:none; font-weight:bold; cursor:pointer; color:black;">PUSH UPDATES</button>
        </div>
    </div>

    <script>
        const clickSfx = () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.frequency.setValueAtTime(900, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + 0.1);
        };

        const rankingIcons = ['üèéÔ∏è', 'üèçÔ∏è', 'üèÉ', 'üö∂'];
        const CSV_LINK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS6tzd7SDpOQ6zHwIGlxNBRFGEG-62iLWa2wMyGyFgjxAWQC3KxP_qBicWEWuBaMsCz1Ydeq-im64_b/pub?gid=0&single=true&output=csv";

        let state = {
            ticker: "SYNCING WITH LIVE ENGINE...",
            lastUpdated: "",
            teams: [],
            staff: []
        };

        async function fetchLiveSync() {
            const syncDot = document.getElementById('syncDot');
            try {
                const response = await fetch(CSV_LINK);
                const csvData = await response.text();
                const rows = csvData.split('\n').map(r => r.split(','));
                
                const tempTeams = [];
                const tempStaff = [];

                rows.slice(1).forEach(cols => {
                    const type = cols[0]?.trim().toLowerCase();
                    if (type === 'team') {
                        tempTeams.push({
                            name: cols[1],
                            leader: cols[2],
                            pct: parseInt(cols[3]) || 0,
                            lastPct: parseInt(cols[4]) || 0,
                            c: cols[5]?.trim() || 'blue'
                        });
                    } else if (type === 'staff') {
                        tempStaff.push({
                            n: cols[1],
                            t: cols[2],
                            p: parseInt(cols[3]) || 0,
                            lastP: parseInt(cols[4]) || 0,
                            lastRank: parseInt(cols[5]) || 1,
                            c: cols[6]?.trim() || 'blue'
                        });
                    }
                });

                state.teams = tempTeams;
                state.staff = tempStaff;
                
                const now = new Date();
                state.lastUpdated = now.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' }) + ", " + now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                const topTeam = tempTeams.sort((a,b) => b.pct - a.pct)[0];
                const topStaff = tempStaff.sort((a,b) => b.p - a.p)[0];
                state.ticker = `Team ${topTeam.name} ${rankingIcons[0]} leading at ${topTeam.pct}% | ${topStaff.n} Star Performer at ${topStaff.p}% | managed by Suraj Prakash v38.6`;

                // Successful sync visual feedback
                syncDot.style.background = 'var(--neon-green)';
                syncDot.style.boxShadow = '0 0 8px var(--neon-green)';
                render();
            } catch (error) {
                console.error("Engine Sync Error:", error);
                syncDot.style.background = 'var(--neon-red)';
                syncDot.style.boxShadow = '0 0 8px var(--neon-red)';
                document.getElementById('lastSyncStamp').innerHTML = `<span id="syncDot" class="sync-dot" style="background:var(--neon-red)"></span>SYNC ERROR - CHECK CONNECTION`;
            }
        }

        function updateCountdown() {
            const endDate = new Date("Jan 27, 2026 00:00:00").getTime();
            const now = new Date().getTime();
            const distance = endDate - now;
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const display = document.getElementById("daysPending");
            display.innerText = days > 0 ? `DEADLINE: ${days} DAYS PENDING` : "RACE CONCLUDED";
            if (days > 0 && days <= 7) { display.classList.add("critical-flash"); }
            else { display.classList.remove("critical-flash"); }
        }

        function render() {
            updateCountdown();
            document.getElementById('liveTicker').innerText = state.ticker;
            if (state.lastUpdated) {
                document.getElementById('lastSyncStamp').innerHTML = `<span id="syncDot" class="sync-dot pulse"></span>LAST REFRESH: ${state.lastUpdated}`;
            }
            const race = document.getElementById('teamRaceCont');
            const grid = document.getElementById('staffGridCont');
            race.innerHTML = ''; grid.innerHTML = '';

            state.teams.sort((a,b) => b.pct - a.pct).forEach((t, idx) => {
                const growth = t.pct - t.lastPct;
                const icon = rankingIcons[idx] || 'üö∂';
                const growthClass = growth > 0 ? 'growth-pos' : 'growth-neg';
                race.innerHTML += `
                    <div class="team-race-row" style="border-left: 4px solid var(--neon-${t.c})">
                        <div style="flex:1;">
                            <div class="c-${t.c}" style="margin-bottom:5px; display:flex; align-items:center;">
                                ${idx === 0 ? '<span class="crown">üëë</span>' : ''} 
                                <span class="team-title-highlight">${t.name.toUpperCase()}</span>
                                <span class="leader-name-bracket">&nbsp;(${t.leader})</span>
                                <span class="team-growth-highlight ${growthClass}">${growth > 0 ? '+' : ''}${growth}%</span>
                            </div>
                            <div class="race-track"><div class="race-bar bg-${t.c}" style="width:${t.pct}%"><span class="race-marker">${icon}</span></div></div>
                        </div>
                        <div class="c-${t.c}" style="font-size:1.3rem; font-weight:bold; margin-left:12px;">${t.pct}%</div>
                    </div>`;
            });

            state.staff.sort((a,b) => b.p - a.p).forEach((s, i) => {
                const curRank = i + 1;
                const rankChg = s.lastRank - curRank;
                const rIcon = rankChg > 0 ? `‚¨ÜÔ∏è #${curRank}` : rankChg < 0 ? `‚¨áÔ∏è #${curRank}` : `‚Ä¢ #${curRank}`;
                const rCol = rankChg > 0 ? 'var(--neon-green)' : rankChg < 0 ? 'var(--neon-red)' : '#aaa';
                const growth = s.p - s.lastP;
                const sGrowthClass = growth > 0 ? 'c-green' : 'c-red';
                grid.innerHTML += `
                    <div class="staff-card" onclick="${s.p >= 100 ? 'party()' : 'clickSfx()'}">
                        <div class="team-badge-highlight bg-${s.c}">${s.t.toUpperCase()}</div>
                        <div class="staff-name-large c-${s.c}">
                            <span>${s.p >= 100 ? '<span class="crown">üëë</span>' : ''}${s.n}</span>
                            <span class="rank-tag" style="background:${rCol}; color:black;">${rIcon}</span>
                        </div>
                        <div class="staff-details">
                            <span class="growth-box ${sGrowthClass}">${growth > 0 ? '+' : ''}${growth}% GROWTH</span>
                            <span style="font-weight:bold;">${s.p}% ACHIEVED</span>
                        </div>
                        <div class="race-track" style="height:6px; margin-top:6px;"><div class="race-bar bg-${s.c}" style="width:${Math.min(s.p, 100)}%"></div></div>
                    </div>`;
            });
        }

        function checkVersion() { alert("MGD Leaderboard\nVersion: 38.6\nCommander: Suraj Prakash\nStatus: LIVE SMART ENGINE"); }
        function party() { clickSfx(); confetti({ particleCount: 150, spread: 60, origin: { y: 0.6 } }); }

        function openAdmin() {
            if(prompt("ACCESS CODE:") === "Suraj@2026") {
                window.open("https://docs.google.com/spreadsheets/d/1vS6tzd7SDpOQ6zHwIGlxNBRFGEG-62iLWa2wMyGyFgjxAWQC3KxP_qBicWEWuBaMsCz1Ydeq-im64_b/edit", "_blank");
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => { 
                        console.log('MGD App Online'); 
                        setInterval(() => { reg.update(); }, 60000); 
                    })
                    .catch(err => console.error('PWA Setup Error:', err));
            });
        }
        
        window.onload = () => {
            fetchLiveSync();
            setInterval(fetchLiveSync, 30000); // 30-second Auto-Refresh
        };
    </script>
</body>
</html>
